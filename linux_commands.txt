### --- PAENIBACILLUS BLAST --- ###

# Acquired Paenibacillus genomes April 21, 2025

export PATH=/programs/ncbi_datasets:$PATH

datasets download genome taxon paenibacillus --include genome,protein,gtf --assembly-source refseq --annotated --filename paeni.zip  

# Removed genomes with ≥5% CheckM contamination and/or ≤95% CheckM completeness using a text file of genomes accessions to remove.

xargs -d '\n' -a genomes_to_remove.txt rm –r

# Combined all protein files to make a BLAST database.

for f in proteins/*/protein.faa; do
    accession=$(basename "$(dirname "$f")")
    awk -v a="$accession" '/^>/ {print ">" a "_" substr($0,2); next} {print}' "$f"
done > proteins_unique.faa

makeblastdb -in proteins_unique.faa -dbtype prot -parse_seqids

# Ran PSI-BLAST. B. subtilis protein seqeunces are from SubtiWiki. After running, we decided to use only the first iteration results, which is equivalent to a BLASTP run.

nohup psiblast -query bs_protein_sequences.fasta -db proteins_unique.faa -outfmt 7 -num_iterations 3 -max_target_seqs 10000 -out psi_blast_paeni.csv

# We extracted the first iteration using select_it1.awk
# The following are the contents of select_it1.awk:

/^# Query:/ {
  query = $0
  next
}

/^# Iteration:/ {
  if ($3 == 1) {
    curr_iter = 1
  } else {
    curr_iter = 0
  }
  next
}

/^#/ { next }  # skip other comment lines

{
  if (curr_iter == 1) print
}

# Extracted BLASTP results.

awk -f select_it1.awk psi_blast_paeni.csv > psi_blast_paeni_it1.csv



### --- PAENIBACILLUS HMMER --- ###
# Used the same proteins_unique.faa file from BLAST
# Query seqeunces were Spo0B from P. polymyxa and P. validus

nohup /programs/hmmer-3.3/bin/phmmer --tblout Paeni_Spo0B_PHMMER_5e2.csv -E 5e-2 Paeni_Spo0B.fasta proteins_unique.faa 


### --- BACILLI HMMER --- ###
# Downloaded all annotated protein sequences from all RefSeq Bacilli reference genomes. INput was a list of RefSeq genome accessions from NCBI online.

datasets download genome accession --inputfile bacilli_accs.txt --include protein --assembly-source refseq --annotated --filename bac_prot.zip 

# Query seqeunces were Spo0B from P. polymyxa, P. validus, Brevibacillus brevis, and B. subtilis

/programs/hmmer-3.3/bin/phmmer --tblout spo0B_pHMMER_mult_5e2.csv -E 5e-2 spo0B.fasta bac_prot.faa  

# Download taxonomy data for Bacilli surveyed. Input was a list of taxIDs from NCBI.

datasets summary taxonomy taxon --inputfile bac_taxids.txt --as-json-lines | dataformat tsv taxonomy --template tax-summary > bac_taxonomy.tsv 

### --- Spo0F, Spo0B, Spo0A ORTHOLOG ALIGNMENT AND PERCENT IDENTITY --- ###
# Protein accession listed in Table S3

/programs/clustalo -i spo0B-domain_containing.fasta -o spo0B_domain-containing_clustalo.fasta --full --percent-id --distmat-out=spo0B_pid_clustal.csv

/programs/clustalo -i spo0F_for_pid.fasta -o spo0F_clustalo.fasta --full --percent-id --distmat-out=spo0F_pid_clustal.csv

/programs/clustalo -i spo0A_for_pid.fasta -o spo0A_clustalo.fasta --full --percent-id --distmat-out=spo0A_pid_clustal.csv



### ---- CONSERVATION PLOT ALIGNMENT --- ###

# Extracted Spo0B protein sequences.
# In Paenibacillus, Spo0B is annotated as either spo0B domain-containing protein or sporulation initiation phosphotransferase B on NBCI.

export PATH=/programs/ncbi_datasets:$PATH
datasets download genome accession --inputfile genome_accs.txt --include protein --filename prot_gtf.zip 

find ncbi_dataset/data -name "protein.faa" | while read file; do
  gcf=$(basename "$(dirname "$file")")
  awk -v gcf="$gcf" '
    /^>/ {
      keep = ($0 ~ /Spo0B/ || $0 ~ /phosphotransferase B/)
      if (keep) print ">[" gcf "] " substr($0, 2)
      next
    }
    keep
  ' "$file"
done > Spo0B_protein.faa

# Added WP_277713256.1 (annotated as hypothetical protein)
# For genomes with >1 Spo0B sequence, we dropped the sequences >300 aa. If there were still >1 Spo0B sequence for a genome, we dropped sequences <210 aa.
# Kept sequences with length between 199-279aa (n = 1437) and saved in Spo0B_protein_cleaned_2.faa

/programs/mafft/bin/mafft --op 3 --ep 0.3 Spo0B_protein_cleaned_2.faa > Spo0B_align_op3_ep_3.fasta 